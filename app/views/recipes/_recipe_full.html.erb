<span id="servings-quantity-value" hidden><%= @recipe.servings_quantity %></span>
<span id="ingredient-list" data-values="<%= @recipe.ingredients.inject({}) {|ings, i|
  qty = i.quantity_model; ings[i.id] = {ml: qty.ml, grams: qty.grams, total: qty.total, unit_weight: i.food.unit_weight, density: i.food.density, raw: i.raw}; ings
}.to_json
%>"/>

<div class="responsive-sm-above">
  <div>
    <% if @recipe.image_id %>
      <%= image_tag medium_image_path(@recipe.image), style: "margin-right: 20px; width: 452px; height: 304px;" if @recipe.image %>
    <% end %>
  </div>
  <div>
    <h1>
      <span class="recipe-title"><%= translated(@recipe.name) %></span>
      <% if user_signed_in? %>
        <div style="display: inline-block;">
          <div class="dropdown" style="display: inline-block; margin-left: 1rem;">
            <%= image_tag asset_path("list.svg"), "data-bs-toggle": "dropdown", style: "cursor: pointer;" %>
            <div class="dropdown-menu">
              <% if @recipe.owned_by?(current_user) %>
                <%= link_to 'Modifier', edit_recipe_path(@recipe), class: "dropdown-item" %>
              <% end %>
              <%= link_to "Créer une variation", new_variant_recipes_path(base_recipe_id: @recipe.id), class: "dropdown-item" %>
              <% if user_signed_in? and current_user.id == @recipe.user_id %>
                <%= form_with(model: @recipe, class: "inline", local: true) do |form| %>
                  <%= form.hidden_field :is_public, value: !@recipe.is_public %>
                  <% if @recipe.is_public %>
                    <%= form.submit "Make private", class: "dropdown-item" %>
                  <% else %>
                    <%= form.submit "Make public", class: "dropdown-item" %>
                  <% end %>
                <% end %>
              <% end %>
              <% user_recipe = @recipe.user_recipe_for(current_user) %>
              <% if user_signed_in? and user_recipe %>
                <%= link_to "Enlever de mes recettes", user_recipe, class: "dropdown-item", method: :delete, data: {confirm: 'Are you sure?'} %>
              <% else %>
                <%= form_with(model: UserRecipe.new, class: "inline") do |form| %>
                  <%= form.hidden_field :recipe_id, value: @recipe.id %>
                  <%= form.submit "Ajouter à mes recettes", class: "dropdown-item" %>
                <% end %>
              <% end %>
                <%= link_to "Ajouter à mon calendrier", nil, "data-bs-toggle": "collapse", "data-bs-target": "#calendar", class: "dropdown-item" %>
            </div>
          </div>
        </div>
      <% end %>
    </h1>
    <p style="max-width: 600px;"><%= @recipe.description %></p>
    <div style="margin-top: 1.5rem;">
      <%= render partial: "details_medium_version", locals: {recipe: @recipe} %>
    </div>
  </div>
</div>

<% if user_signed_in? %>
  <% machine = current_user.machines.first_or_create %>
  <div class="collapse" id="calendar">
    <%= render partial: "meals/calendar", locals: {recipe: @recipe, machine: machine, meals: machine.meals.includes(:recipe) } %>
    <div style="height: 10px;"></div>
  </div>
<% end %>
  
<div class="recipe-body">
  
<div style="height: 1rem;"></div>

<% variants = @recipe.all_variants %>
<% unless variants.blank?  %>

<style>
  .var-list {
    align-items: center;
    font-size: 1.1rem;
    background-color: #212529;
    width: 100%;
    height: 36.5px;
    display: flex;
  }
  .var-list > * {
    padding-left: 1rem;
    padding-right: 1rem;
    color: #ddd;
  }
</style>

<div class="var-list">
  <div style="color: white; font-size: 1rem;">Versions:</div>
  <div style="font-weight: 500; color: black; background-color: white; border-radius: 5px; padding-top: 0.5rem; padding-bottom: 0.5rem; transform: translate(0px, 3px);">
    <div style="transform: translate(0px, -3px);">
      <%= @recipe.version_name.blank? ? "Original" : capitalize_first_letter(@recipe.version_name) %>
    </div>
    <%# @recipe.version_name.blank? ? "Original" : capitalize_first_letter(@recipe.version_name) + " ⭐⭐⭐⭐⭐" %>
  </div>
  <% variants.each do |variant| %>
    <%= link_to variant.version_name.capitalize, variant, class: "nav-link" %>
    <%# link_to variant.version_name.capitalize + " ⭐⭐⭐⭐⭐", variant, class: "nav-link" %>
  <% end %>
  <% if user_signed_in? %>
    <%= link_to "+", new_variant_recipes_path(base_recipe_id: @recipe.id), class: "nav-link" %>
  <% end %>
</div>
<% end %>

<div style="height: 1.5rem;"></div>
  <!-- TODO: Si un ingrédient se retrouve plusieurs fois dans la recette, afficher un avertissement et la quantité totale comme ça le monde peuvent savoir s'ils en ont assez -->
  
  <% unless @recipe.ingredients.blank? %>
    
    <!--<%# @recipe.ingredients.each do |ing| %>
      <%# next if ing.food.producing_recipes.blank? %>
      <%# r = ing.food.producing_recipes.first %>
      <h2 class="h2 toggle-link" data-toggle_id="sub_recipe_<%# r.id %>">+ Comment faire: <%# r.name %></h2>
      <div id="sub_recipe_<%# r.id %>" class="recipe-instructions" hidden>
        <%# pretty_complete_instructions(r) %>
      </div>
    <%# end %>
    -->
    
    <h2 class="h2">Ingrédients</h2>

    <div style="height: 0.5rem;"></div>

    <div id="ing_list">
      <ul class="list-group">
        <% @recipe.ingredients.order(:item_nb).each do |ing| %>
          <li class="list-group-item">
            <%= scalable_detailed_ingredient(ing) %>

            <div class="dropdown" style="display: inline-block; float: right">
               <%= image_tag asset_path("pencil-square.svg"), "data-bs-toggle": "dropdown", style: "cursor: pointer;" %>
              <div class="dropdown-menu">
                <a class="dropdown-item" href="#">Retirer</a>
                <% unless ing.food.substitutions.blank? %>
                  <h6 class="dropdown-header">Remplacer par</h6>
                  <% ing.food.substitutions.each do |sub| %>
                    <a class="dropdown-item" href="#"><%= pretty_substitution(ing, sub) %></a>
                  <% end %>
                <% end %>
              </div>
            </div>
            <%# link_to image_tag(asset_path("pencil-square.svg")), "FIXME", style: "float: right;" %>
          </li>
        <% end %>
      </ul>

      <div style="height: 4px;"></div>

      <div style="display: flex; justify-content: space-between; margin-top: 0.25rem; flex-wrap: wrap;">
        <div>
          <% val = @recipe.main_ingredient ? @recipe.main_ingredient.raw : '' %>
          <%= text_field_tag :quantity, val, class: "form-control", style: "width: 9rem; display: inline; text-align: right;", "data-quantity": val, id: "ingredient-qty-input-field" %>
          <%= collection_select :foo, :input_ingredient, @recipe.ingredients, :id, :name, {selected: @recipe.main_ingredient_id}, class: "form-select", id: "input-ingredients", style: "display: inline-block; width: auto;" %>
        </div>
        <div>
          <%= image_tag asset_path("right_arrow.svg"), style: "width: 1.5rem;" %>
        </div>
        <div>
          <%= image_tag(asset_path("minus-square.svg"), style: "cursor: pointer; width: 1.5rem;", id: "less-servings-button") %>
          <%= text_field_tag :servings, @recipe.servings, style: "width: 9rem; display: inline; text-align: right;", class: "form-control", id: "servings-input-field", "data-initial": @recipe.servings %>
          <%= image_tag(asset_path("plus-square.svg"), style: "cursor: pointer; width: 1.5rem;", id: "more-servings-button") %>
        </div>
      </div>
    </div>
  
  <% end %>

  <h2 class="h2" style="margin-top: 2rem;">Instructions</h2>
  
  <div class="recipe-instructions">
  
    <%= pretty_complete_instructions(@recipe) %>
    <%# pretty_print_recipe(@recipe) %>
  </div>
  
  <% unless @recipe.similar_recipes.blank? %>
    <h2>Recettes similaires</h2>
  
    <h3><%= link_to translated(@recipe.similar_recipes.first.name), @recipe.similar_recipes.first %></h3>
    <%= pretty_print_recipe(@recipe.similar_recipes.first) %>
  <% end %>
  
  <h2 class="h2" style="margin-top: 2rem;">Commentaires</h2>

  <%= translated("Aucun commentaire pour l'instant.") %>

  <div style="height: 3rem;"></div>
</div>

<%# javascript_pack_tag "recipe" %>
<%= javascript_pack_tag "toggle_link" %>
<%= javascript_pack_tag "dropdown_submenu" %>
<%= javascript_pack_tag current_user ? "recipe_rating" : "recipe_rating_read_only" %>
<%= javascript_pack_tag "recipes_show" %>
